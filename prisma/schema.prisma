generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "public"), vector]
}

model User {
  id               String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  username         String           @unique @db.VarChar(50)
  name             String?          @db.VarChar(100)
  email            String           @unique @db.VarChar(255)
  password_hash    String           @db.VarChar(255)
  telegram_id      String?          @unique @db.VarChar(100)
  refresh_token    String?          @db.VarChar(500)
  created_at       DateTime?        @default(now()) @db.Timestamp(6)
  conversations    Conversation[]
  knowledge_chunks KnowledgeChunk[]
  relationships    Relationship[]
  style_profile    StyleProfile?
  tone_samples     ToneSample[]

  @@map("users")
}

model Partner {
  id            String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name          String         @db.VarChar(100)
  telegram_id   String?        @unique @db.VarChar(100)
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  conversations Conversation[]
  relationships Relationship[]

  @@map("partners")
}

model Conversation {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String    @db.Uuid
  partner_id String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  partner    Partner   @relation(fields: [partner_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  messages   Message[]

  @@unique([user_id, partner_id])
  @@index([partner_id], map: "idx_conversations_partner_id")
  @@index([user_id], map: "idx_conversations_user_id")
  @@map("conversations")
}

model Message {
  id                String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversation_id   String            @db.Uuid
  role              MessageRole
  text              String
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  message_embedding MessageEmbedding?
  conversation      Conversation      @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversation_id, created_at], map: "idx_messages_conversation_created")
  @@map("messages")
}

model Relationship {
  id          String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id     String               @db.Uuid
  partner_id  String               @db.Uuid
  category    RelationshipCategory
  politeness  PolitenessLevel?     @default(POLITE)
  vibe        VibeType?            @default(CALM)
  emoji_level Int?                 @default(0) @db.SmallInt
  created_at  DateTime?            @default(now()) @db.Timestamp(6)
  updated_at  DateTime?            @default(now()) @updatedAt @db.Timestamp(6)
  partner     Partner              @relation(fields: [partner_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user        User                 @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, partner_id])
  @@index([partner_id], map: "idx_relationships_partner_id")
  @@index([user_id], map: "idx_relationships_user_id")
  @@map("relationships")
}

model StyleProfile {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id         String    @unique @db.Uuid
  honorific_rules Json?     @default("{}")
  constraints     Json?     @default("{}")
  updated_at      DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("style_profiles")
}

model ToneSample {
  id         String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String                 @db.Uuid
  text       String
  category   RelationshipCategory?
  politeness PolitenessLevel?
  vibe       VibeType?
  embedding  Unsupported("vector")?
  created_at DateTime?              @default(now()) @db.Timestamp(6)
  user       User                   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category], map: "idx_tone_samples_category")
  @@index([embedding], map: "idx_tone_samples_embedding")
  @@index([user_id], map: "idx_tone_samples_user_id")
  @@map("tone_samples")
}

model KnowledgeChunk {
  id         String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id    String                 @db.Uuid
  source     String?                @db.VarChar(255)
  title      String?                @db.VarChar(255)
  chunk      String
  metadata   Json?                  @default("{}")
  embedding  Unsupported("vector")?
  created_at DateTime?              @default(now()) @db.Timestamp(6)
  user       User                   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([embedding], map: "idx_knowledge_chunks_embedding")
  @@index([user_id], map: "idx_knowledge_chunks_user_id")
  @@map("knowledge_chunks")
}

model MessageEmbedding {
  message_id String                @id @db.Uuid
  embedding  Unsupported("vector")
  created_at DateTime?             @default(now()) @db.Timestamp(6)
  message    Message               @relation(fields: [message_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([embedding], map: "idx_message_embeddings_embedding")
  @@map("message_embeddings")
}

enum RelationshipCategory {
  FAMILY_ELDER_CLOSE
  FAMILY_SIBLING_ELDER
  FAMILY_SIBLING_YOUNGER
  PARTNER_INTIMATE
  FRIEND_CLOSE
  ACQUAINTANCE_CASUAL
  WORK_SENIOR_FORMAL
  WORK_SENIOR_FRIENDLY
  WORK_PEER
  WORK_JUNIOR
}

enum PolitenessLevel {
  FORMAL
  POLITE
  CASUAL
}

enum VibeType {
  CALM
  DIRECT
  PLAYFUL
  CARING
}

enum MessageRole {
  user
  assistant
  system
}
